<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <title>Neural Radiance Field</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="../icon.png">

</head>

<body>
    <main class="">
        <nav class="navbar navbar-expand-lg py-2 px-xl-5" style="z-index: 100;">
            <div class="container-xxl d-flex align-items-lg-center justify-content-between">
                <a class="navbar-brand" href="https://inst.eecs.berkeley.edu/~cs180/fa24/">Computer Vision</a>
                <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item ms-lg-3 dropdown">
                            <a class="nav-link link-dark" href="/1/">Project 1</a>
                        </li>
                        <li class="nav-item ms-lg-3">
                            <a class="nav-link link-dark" href="/2/">Project 2</a>
                        </li>
                        <li class="nav-item ms-lg-3">
                            <a class="nav-link link-dark" href="/3/">Project 3</a>
                        </li>
                        <li class="nav-item ms-lg-3">
                            <a class="nav-link link-dark" href="/4/">Project 4</a>
                        </li>
                        <li class="nav-item ms-lg-3">
                            <a class="nav-link link-dark" href="/5/">Project 5</a>
                        </li>
                        <li class="nav-item ms-lg-3">
                            <a class="nav-link link-dark" href="/6/">Final Project</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container legal-text-block">
            <h1 class="text-center">Final Project: <br>Neural Radiance Field!</h1>
            <hr class="mb-5">
            <p>
                In this final project, we are going to implement Neural Radiance Field from scratch<br>
                Newer methods like Gaussian Splatting have made things faster and improved the quality of
                rendering. But by creating NeRF
                step by step, we will really get a feel for how it works, like how volume rendering is handled,
                position encodings, and how to train a neural network to reconstruct a scene. Plus, it will give us a
                solid
                understanding of the basics.
                Same as our last project, we will split this project into two parts.
            </p>
            <h2>Part 1: Fit a Neural Field to a 2D Image</h2>
            <hr>
            <p>
                Before we jump into implementing a real NeRF though, we will first try it out on a 2D image.
                Nerf is basically a neural network that has learned a 3D scene, each "weight" is a spot in the 3D space
                that
                has a color and an opacity. Color and opacity is the output of our model, and the input is the 3D
                position of
                the point we want to render and the viewing direction.
            </p>
            <p>
                Since we are starting with 2D, we first just create a model that only takes 2D input, so the xy
                coordinates of the image.
                It then returns the rgb color of the pixel.
            </p>
            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_1.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Our 2D neural network architecture
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <p>
                Our architecture is a simple feedforward neural network with 3 hidden layers. We use ReLU as our
                activation function, but
                we also use a Sinusoidal Positional Encoding (PE), which expands its dimensionality and tells our model
                where in the image the pixel is located.
            </p>
            <p>
                We also keep the original input in the PE so the formulation is:
            </p>
            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mi>P</mi>
                <mi>E</mi>
                <mo stretchy="false">(</mo>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>=</mo>
                <mo fence="false" stretchy="false">{</mo>
                <mi>x</mi>
                <mo>,</mo>
                <mi>s</mi>
                <mi>i</mi>
                <mi>n</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mn>0</mn>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>,</mo>
                <mi>c</mi>
                <mi>o</mi>
                <mi>s</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mn>0</mn>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>,</mo>
                <mi>s</mi>
                <mi>i</mi>
                <mi>n</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mn>1</mn>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>,</mo>
                <mi>c</mi>
                <mi>o</mi>
                <mi>s</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mn>1</mn>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>,</mo>
                <mo>.</mo>
                <mo>.</mo>
                <mo>.</mo>
                <mo>,</mo>
                <mi>s</mi>
                <mi>i</mi>
                <mi>n</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mrow data-mjx-texclass="ORD">
                        <mi>L</mi>
                        <mo>&#x2212;</mo>
                        <mn>1</mn>
                    </mrow>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo>,</mo>
                <mi>c</mi>
                <mi>o</mi>
                <mi>s</mi>
                <mo stretchy="false">(</mo>
                <msup>
                    <mn>2</mn>
                    <mrow data-mjx-texclass="ORD">
                        <mi>L</mi>
                        <mo>&#x2212;</mo>
                        <mn>1</mn>
                    </mrow>
                </msup>
                <mi>&#x3C0;</mi>
                <mi>x</mi>
                <mo stretchy="false">)</mo>
                <mo fence="false" stretchy="false">}</mo>
            </math>

            <h3>Part 0: Setup</h3>
            <p>
                We are going to use the diffusion model DeepFloyd, to generate our images using text input.
                It is a two stage model by Stability AI. In the first stage it first generates a 64x64 image from the
                text input and then in the second stage it generates a 256x256 image by upsampling the 64x64 image.
            </p>
            <p>
                Lets see what our diffucion model generates, if we feed it some prompts. We use the following prompts:
                "an oil painting of a snowy mountain village"<br>
                "a man wearing a hat"<br>
                "a rocket ship"<br>
            </p>
            <p>
                The results are shown below, I used different amounts of inference steps to generate the images:
            </p>
            <p>
                We now implement a dataloader that randomly selects N samples at every iteration during training.
                Giving us the coodinates of the pixel as Nx2 and also the rgb values of the pixel as Nx3.
                We use some normalization for better results: (x = x / image_width, y = y / image_height) and the colors
                (rgbs = rgbs / 255.0)
            </p>
            <p>
                We further use the Adam optimizer with a learning rate of 1e-4 and train the model for 1000 iterations,
                and get the following results:
            </p>
            <p>
                The below images show the process of optimizing the network to fit on this image:
                Here I have choosen the following hyperparameters:
                Learning rate: 1e-2 <br>
                Hidden Size: 256
                L: 10
                Batch Size: 10,000
            </p>
            <div class="row row-cols-1 row-cols-md-3 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_10.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                10 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_100.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                100 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_200.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                200 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_400.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                400 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_1000.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                1000 Iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_g.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Plot showing the training PSNR across iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                We run the same on a different image, with the same hyperparameters and get the following results:
            </p>

            <div class="row row-cols-1 row-cols-md-3 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_3_10.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                10 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_3_100.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                100 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_3_200.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                200 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_3_400.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                400 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_3_1000.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                1000 Iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_2_g.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Plot showing the training PSNR four our second image across iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                Now we try the hyperparameter tuning. We start with tuning our L and set it to 40.<br>
                We get the following results, which show us that setting L to a very high value does not improve the
                results:
            </p>

            <div class="row row-cols-1 row-cols-md-2 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_4_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Our image result after 1000 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_4_2.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Our training curve for L=40
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                Now we try the hyperparameter tuning with a different parameter. We try to set our hidden dimension to
                32 instead of 256.<br>
                We get the following results, which show us that setting our hidden dimension to a lower value does
                decrease our result.
                Our network does not have a big enough capacity to learn the image anymore:
            </p>

            <div class="row row-cols-1 row-cols-md-2 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/1_5_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Our image result after 1000 Iterations (hidden dimension = 32)
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/1_5_2.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Our training curve for hidden dimension = 32
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <h3>Part 2: Fit a Neural Radiance Field from Multi-view Images</h3>
            <p>
                Now we are familiar with the basics of NeRF, trying to fit it to learn a 2D image, we can not transition
                to 3D.
                For this we are going to use the Lego Bulldozer dataset from the original <a
                    href="https://www.matthewtancik.com/nerf">NeRF Paper</a>.
                We use a resulution of 200x200.
            </p>
            <p>
                For this we first need to implement the conversion of 3D camera coordinates into 3D world coordinates,
                we imlement the following function.
            </p>
            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mtable displaystyle="true" columnalign="right" columnspacing="" rowspacing="3pt">
                    <mtr>
                        <mtd>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">[</mo>
                                <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>x</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>y</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>z</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <mn>1</mn>
                                        </mtd>
                                    </mtr>
                                </mtable>
                                <mo data-mjx-texclass="CLOSE">]</mo>
                            </mrow>
                            <mo>=</mo>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">[</mo>
                                <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mrow data-mjx-texclass="ORD">
                                                    <mi mathvariant="bold">R</mi>
                                                </mrow>
                                                <mrow data-mjx-texclass="ORD">
                                                    <mn>3</mn>
                                                    <mo>&#xD7;</mo>
                                                    <mn>3</mn>
                                                </mrow>
                                            </msub>
                                        </mtd>
                                        <mtd>
                                            <mrow data-mjx-texclass="ORD">
                                                <mi mathvariant="bold">t</mi>
                                            </mrow>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mrow data-mjx-texclass="ORD">
                                                    <mn mathvariant="bold">0</mn>
                                                </mrow>
                                                <mrow data-mjx-texclass="ORD">
                                                    <mn>1</mn>
                                                    <mo>&#xD7;</mo>
                                                    <mn>3</mn>
                                                </mrow>
                                            </msub>
                                        </mtd>
                                        <mtd>
                                            <mn>1</mn>
                                        </mtd>
                                    </mtr>
                                </mtable>
                                <mo data-mjx-texclass="CLOSE">]</mo>
                            </mrow>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">[</mo>
                                <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>x</mi>
                                                <mi>w</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>y</mi>
                                                <mi>w</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>z</mi>
                                                <mi>w</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <mn>1</mn>
                                        </mtd>
                                    </mtr>
                                </mtable>
                                <mo data-mjx-texclass="CLOSE">]</mo>
                            </mrow>
                        </mtd>
                    </mtr>
                </mtable>
            </math>
            <p>
                Then we implement the function to convert 2D image coordinates into 3D camera coordinates.
                Here we just need to implement the following function:
            </p>


            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mtable displaystyle="true" columnalign="right" columnspacing="" rowspacing="3pt">
                    <mtr>
                        <mtd>
                            <mi>s</mi>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">[</mo>
                                <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                                    <mtr>
                                        <mtd>
                                            <mi>u</mi>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <mi>v</mi>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <mn>1</mn>
                                        </mtd>
                                    </mtr>
                                </mtable>
                                <mo data-mjx-texclass="CLOSE">]</mo>
                            </mrow>
                            <mo>=</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">K</mi>
                            </mrow>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">[</mo>
                                <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>x</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>y</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                    <mtr>
                                        <mtd>
                                            <msub>
                                                <mi>z</mi>
                                                <mi>c</mi>
                                            </msub>
                                        </mtd>
                                    </mtr>
                                </mtable>
                                <mo data-mjx-texclass="CLOSE">]</mo>
                            </mrow>
                        </mtd>
                    </mtr>
                </mtable>
            </math>


            <p>
                After we can implement the function to turn pixel coordinates into rays. For this function we need the
                K, camera to world matrix
                and the pixel coordinates. We find the camera origin by just transforming the origin of the camera with
                our previous cam to world function.
            </p>

            <p>
                For finding the ray direction we use the following function:
            </p>
            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mtable displaystyle="true" columnalign="right" columnspacing="" rowspacing="3pt">
                    <mtr>
                        <mtd>
                            <msub>
                                <mrow data-mjx-texclass="ORD">
                                    <mi mathvariant="bold">r</mi>
                                </mrow>
                                <mi>d</mi>
                            </msub>
                            <mo>=</mo>
                            <mfrac>
                                <mrow>
                                    <mrow data-mjx-texclass="ORD">
                                        <msub>
                                            <mi mathvariant="bold">X</mi>
                                            <mi mathvariant="bold">w</mi>
                                        </msub>
                                    </mrow>
                                    <mo>&#x2212;</mo>
                                    <msub>
                                        <mrow data-mjx-texclass="ORD">
                                            <mi mathvariant="bold">r</mi>
                                        </mrow>
                                        <mi>o</mi>
                                    </msub>
                                </mrow>
                                <mrow>
                                    <mo stretchy="false">|</mo>
                                    <mrow data-mjx-texclass="ORD">
                                        <mo stretchy="false">|</mo>
                                    </mrow>
                                    <mrow data-mjx-texclass="ORD">
                                        <msub>
                                            <mi mathvariant="bold">X</mi>
                                            <mi mathvariant="bold">w</mi>
                                        </msub>
                                    </mrow>
                                    <mo>&#x2212;</mo>
                                    <msub>
                                        <mrow data-mjx-texclass="ORD">
                                            <mi mathvariant="bold">r</mi>
                                        </mrow>
                                        <mi>o</mi>
                                    </msub>
                                    <mrow data-mjx-texclass="ORD">
                                        <mo stretchy="false">|</mo>
                                    </mrow>
                                    <msub>
                                        <mo stretchy="false">|</mo>
                                        <mn>2</mn>
                                    </msub>
                                </mrow>
                            </mfrac>
                        </mtd>
                    </mtr>
                </mtable>
            </math>

            <p>
                Now we adjust our dataloader to sample rays from the images. We sample random rays by first sampling a
                batch size of
                200x200 u and v coordinates and then stacking them on top of each other. We then apply our previous
                mentioned
                functions to get the rays, that means the ray origin and the ray direction, then we also add the
                lable/rgb values.
                We sample randomly by just selecting random entries from this stack.
                We also shift the coordinates by 0.5 to make sure that we are sampling from the middle of the pixel and
                not the corner.
                Once we have the ray origin and ray direction, we sample multiple points on this ray between 2 and 6.
            </p>
            <p>
                We can now use viser to visualize our cameras, rays and points on our rays, to make sure we have the
                right setup:
            </p>

            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_3_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                This is the visualization of our setup. We are displaying all cameras and then choosing
                                random rays to
                                display. We then display the points on the rays that we are going to sample.
                                These are the rays and samples we draw at every iteration training step.
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_3_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                This is the visualization of only one camera in our setup. We are choosing random rays
                                from this one
                                camera so see whether the rays are all inside the frustum.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                Now we can continue on to implement the architecture of our NeRF model. We use the following
                architecture:
            </p>

            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_4_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                This new architecutre is very similar to our old network we used in 2D but we are
                                extending it by
                                changing it to accept 3D input, which is first a 3D point in our space and then second a
                                3D viewing
                                direction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                We make it to ourput a 3D RGB color and also a density value of the pixel.
            </p>
            <p>
                We use Sigmoid to set the output color within range (0, 1), and use ReLU to set the output density to be
                non negative. We also adjust our PE function to accept 3D input concatonate it with our RGB output
                branch.
            </p>

            <p>
                One we have set up our network we can now create our volume redering function. While the actual volume
                rendering function is as follows:
            </p>

            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mtable displaystyle="true" columnalign="right" columnspacing="" rowspacing="3pt">
                    <mtr>
                        <mtd>
                            <mi>C</mi>
                            <mo stretchy="false">(</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">r</mi>
                            </mrow>
                            <mo stretchy="false">)</mo>
                            <mo>=</mo>
                            <msubsup>
                                <mo data-mjx-texclass="OP">&#x222B;</mo>
                                <mrow data-mjx-texclass="ORD">
                                    <msub>
                                        <mi>t</mi>
                                        <mi>n</mi>
                                    </msub>
                                </mrow>
                                <mrow data-mjx-texclass="ORD">
                                    <msub>
                                        <mi>t</mi>
                                        <mi>f</mi>
                                    </msub>
                                </mrow>
                            </msubsup>
                            <mi>T</mi>
                            <mo stretchy="false">(</mo>
                            <mi>t</mi>
                            <mo stretchy="false">)</mo>
                            <mi>&#x3C3;</mi>
                            <mo stretchy="false">(</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">r</mi>
                            </mrow>
                            <mo stretchy="false">(</mo>
                            <mi>t</mi>
                            <mo stretchy="false">)</mo>
                            <mo stretchy="false">)</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">c</mi>
                            </mrow>
                            <mo stretchy="false">(</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">r</mi>
                            </mrow>
                            <mo stretchy="false">(</mo>
                            <mi>t</mi>
                            <mo stretchy="false">)</mo>
                            <mo>,</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">d</mi>
                            </mrow>
                            <mo stretchy="false">)</mo>
                            <mi>d</mi>
                            <mi>t</mi>
                            <mo>,</mo>
                            <mtext>&#xA0;where&#xA0;</mtext>
                            <mi>T</mi>
                            <mo stretchy="false">(</mo>
                            <mi>t</mi>
                            <mo stretchy="false">)</mo>
                            <mo>=</mo>
                            <mi>exp</mi>
                            <mo data-mjx-texclass="NONE">&#x2061;</mo>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">(</mo>
                                <mo>&#x2212;</mo>
                                <msubsup>
                                    <mo data-mjx-texclass="OP">&#x222B;</mo>
                                    <mrow data-mjx-texclass="ORD">
                                        <msub>
                                            <mi>t</mi>
                                            <mi>n</mi>
                                        </msub>
                                    </mrow>
                                    <mi>t</mi>
                                </msubsup>
                                <mi>&#x3C3;</mi>
                                <mo stretchy="false">(</mo>
                                <mrow data-mjx-texclass="ORD">
                                    <mi mathvariant="bold">r</mi>
                                </mrow>
                                <mo stretchy="false">(</mo>
                                <mi>s</mi>
                                <mo stretchy="false">)</mo>
                                <mo stretchy="false">)</mo>
                                <mi>d</mi>
                                <mi>s</mi>
                                <mo data-mjx-texclass="CLOSE">)</mo>
                            </mrow>
                        </mtd>
                    </mtr>
                </mtable>
            </math>


            <p>
                We have to use the discrete version of this function, as we can not integrate over the continuous space:
            </p>

            <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
                <mtable displaystyle="true" columnalign="right" columnspacing="" rowspacing="3pt">
                    <mtr>
                        <mtd>
                            <mrow data-mjx-texclass="ORD">
                                <mover>
                                    <mi>C</mi>
                                    <mo stretchy="false">^</mo>
                                </mover>
                            </mrow>
                            <mo stretchy="false">(</mo>
                            <mrow data-mjx-texclass="ORD">
                                <mi mathvariant="bold">r</mi>
                            </mrow>
                            <mo stretchy="false">)</mo>
                            <mo>=</mo>
                            <munderover>
                                <mo data-mjx-texclass="OP">&#x2211;</mo>
                                <mrow data-mjx-texclass="ORD">
                                    <mi>i</mi>
                                    <mo>=</mo>
                                    <mn>1</mn>
                                </mrow>
                                <mi>N</mi>
                            </munderover>
                            <msub>
                                <mi>T</mi>
                                <mi>i</mi>
                            </msub>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">(</mo>
                                <mn>1</mn>
                                <mo>&#x2212;</mo>
                                <mi>exp</mi>
                                <mo data-mjx-texclass="NONE">&#x2061;</mo>
                                <mrow data-mjx-texclass="INNER">
                                    <mo data-mjx-texclass="OPEN">(</mo>
                                    <mo>&#x2212;</mo>
                                    <msub>
                                        <mi>&#x3C3;</mi>
                                        <mi>i</mi>
                                    </msub>
                                    <msub>
                                        <mi>&#x3B4;</mi>
                                        <mi>i</mi>
                                    </msub>
                                    <mo data-mjx-texclass="CLOSE">)</mo>
                                </mrow>
                                <mo data-mjx-texclass="CLOSE">)</mo>
                            </mrow>
                            <msub>
                                <mrow data-mjx-texclass="ORD">
                                    <mi mathvariant="bold">c</mi>
                                </mrow>
                                <mi>i</mi>
                            </msub>
                            <mo>,</mo>
                            <mtext>&#xA0;where&#xA0;</mtext>
                            <msub>
                                <mi>T</mi>
                                <mi>i</mi>
                            </msub>
                            <mo>=</mo>
                            <mi>exp</mi>
                            <mo data-mjx-texclass="NONE">&#x2061;</mo>
                            <mrow data-mjx-texclass="INNER">
                                <mo data-mjx-texclass="OPEN">(</mo>
                                <mo>&#x2212;</mo>
                                <munderover>
                                    <mo data-mjx-texclass="OP">&#x2211;</mo>
                                    <mrow data-mjx-texclass="ORD">
                                        <mi>j</mi>
                                        <mo>=</mo>
                                        <mn>1</mn>
                                    </mrow>
                                    <mrow data-mjx-texclass="ORD">
                                        <mi>i</mi>
                                        <mo>&#x2212;</mo>
                                        <mn>1</mn>
                                    </mrow>
                                </munderover>
                                <msub>
                                    <mi>&#x3C3;</mi>
                                    <mi>j</mi>
                                </msub>
                                <msub>
                                    <mi>&#x3B4;</mi>
                                    <mi>j</mi>
                                </msub>
                                <mo data-mjx-texclass="CLOSE">)</mo>
                            </mrow>
                        </mtd>
                    </mtr>
                </mtable>
            </math>

            <p>
                We can understand this through an analogy, where the ray travels through the volume and depending on the density and color, picks up on Color
                and ends up with a saturated final color.<br>
                C is the color obtained from the network, Ti is the probability of the ray not termonating before the sampling location i.
            </p>
            <p>
                We then implement the training loop, which uses the previously mentioned dataset function to get the ray origin and ray direction from our
                intrinsic matrix, pixels and camera to world matrix. We then use the network to get the color and density of the pixel by feeding the 
                points and ray direction into the model. 
            </p>
            <p>
                We train 1000 iterations with a batch size of 10.000 pixels and a learning rate of 1e-3.
                In the following we can see the training loop and the results of the training loop, these specifically
                do not show a training sample but an unseen validation sample:
            </p>


            <div class="row row-cols-1 row-cols-md-3 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_50.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                10 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_100.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                After 100 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_150.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                After 150 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_300.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                After 300 Iterations
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_800.jpg" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                After 800 Iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-1 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_1.png" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Plot showing the validation PSNR of our 3D nerf model across iterations
                            </p>
                        </div>
                    </div>
                </div>
            </div>



            <p>
                This is our final result. I have used the camera intrinsics from our test dataset to generate images and create
                a spinning 3D gif view of our Lego Bulldozer.
            </p>

            <div class="row row-cols-1 row-cols-md-2 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_5_2.gif" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Gif showing the Lego Bulldozer from different angles
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                For the final part we are going to implement the bells and whisles of displaying the depth. It is very similar to the mentioned volrendering part, only
                that we only output our sigma and use the sigma to display our depth. Since it is only a scalar, we render normalize it and render it in grey.
                Instead of compositing the point colors to the pixel color in the volume rendering, we in addition  composite the point depths per point to the pixel depth.
            </p>
            <p>
                The following shows our gif of the depth of the Lego Bulldozer:
            </p>
            <div class="row row-cols-1 row-cols-md-2 g-4 my-4">
                <div class="col">
                    <div class="card">
                        <img src="data/2_6_2.gif" class="card-img-top" alt="...">
                        <div class="card-body">
                            <p class="card-text">
                                Gif showing the depth of the Lego Bulldozer from different angles
                            </p>
                        </div>
                    </div>
                </div>
            </div>




        </div>

    </main>
    <footer class="my-3">
        <div class="container-lg">
            <hr>
            <div style="font-size: .75rem">
                <div class="text-muted">By Boyong Wu 🌱</div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>


    </script>
    <script>
        const slider = document.getElementById('slider');
        const gifFrame = document.getElementById('gifFrame');

        slider.addEventListener('input', function () {
            const frameNumber = this.value;
            gifFrame.src = `data/morphed/morphed_${frameNumber}.png`;  // Replace with actual frame images
        });

        const slider2 = document.getElementById('slider2');
        const gifFrame2 = document.getElementById('gifFrame2');

        slider2.addEventListener('input', function () {
            const frameNumber = this.value;
            gifFrame2.src = `data/morphed/morphed_${frameNumber}.png`;  // Replace with actual frame images
        });
    </script>
</body>

</html>